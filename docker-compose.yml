version: "3.8"

services:
  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: gcw_user
      POSTGRES_PASSWORD: changeme
      POSTGRES_DB: gcw_db
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    image: golang:1.23
    restart: unless-stopped
    working_dir: /src
    volumes:
      - ./:/src
    # environment embedded here (placeholders)
    # environment:
    #   ENVIRONMENT: "local"
    #   VERSION: "1"
    #   APP_NAME: "GCW"
    #   PORT: "8000"
    #   MODE: "debug"
    #   HOST_HEADER: "localhost:8000"
    #   CORS_ORIGIN: "http://localhost:3000"
    #   API_BASE_URL: "/api/v1/gcw/resources"
    #   ADMIN_API_BASE_URL: "/admin/api/v1/gcw/resources"

    #   DB_CONNECTION: "postgres"
    #   DB_HOST: "db"
    #   DB_PORT: "5432"
    #   DB_NAME: "gcw_db"
    #   DB_USER: "gcw_user"
    #   DB_PASS: "changeme"

    #   JWT_SECRET: "change_me_secret"
    #   JWT_REFRESH_SECRET: "change_me_refresh_secret"
    #   JWT_ISSUER: "gcw"

    #   EMAIL_HOST: "smtp.gmail.com"
    #   EMAIL_PORT: "587"
    #   EMAIL_USERNAME: "your-email@gmail.com"
    #   EMAIL_PASSWORD: "your-email-password"
    #   EMAIL_FROM: "no-reply@yourdomain.com"

    #   GOOGLE_CLIENT_ID: "your-google-client-id.apps.googleusercontent.com"

    #   DOMJUDGE_URL: "https://domjudge.example.com"
    #   DOMJUDGE_CONTEST_ID: "1"
    #   DOMJUDGE_USERNAME: "domjudge_user"
    #   DOMJUDGE_PASSWORD: "domjudge_password"

    command: /bin/sh -c "go mod download && CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /src/gcw main.go && /src/gcw"
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  db-data:
    driver: local

# Notes:
# - Dokploy clones the repo before running docker-compose; this compose expects the repo files present (build: .)
# - Copy `.env.example` to `.env` and set real secrets before deploy.
# - For production set ENVIRONMENT=production and secure secrets via Dokploy secrets or an external secrets manager.
